<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ailabs CapCut Lite (60FPS Render)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Anton&family=Bebas+Neue&family=Chewy&family=Comic+Neue:wght@700&family=Creepster&family=Dancing+Script:wght@700&family=Fredoka+One&family=Inter:wght@400;700&family=Lobster&family=Montserrat:wght@700&family=Oswald:wght@500&family=Pacifico&family=Permanent+Marker&family=Playfair+Display:wght@700&family=Poppins:wght@600&family=Press+Start+2P&family=Righteous&family=Roboto:wght@500&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #000000; color: white; overflow: hidden; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #121212; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* Subtitle Overlay & Text */
        #subtitle-overlay {
            position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
            pointer-events: none; z-index: 50; overflow: hidden;
        }
        #subtitle-text {
            pointer-events: auto; user-select: none; cursor: move;
            transition: transform 0.1s; line-height: 1.2;
            width: max-content; max-width: 90%;
            text-shadow: 2px 2px 2px rgba(0,0,0,0.8); opacity: 1; display: inline-block;
        }
        #subtitle-text:active { opacity: 0.9; outline: 2px dashed #3b82f6; }

        /* Animations */
        @keyframes slideUp { 0% { transform: translate(-50%, 20px); opacity: 0; } 100% { transform: translate(-50%, 0); opacity: 1; } }
        @keyframes popIn { 0% { transform: translate(-50%, 0) scale(0.5); opacity: 0; } 80% { transform: translate(-50%, 0) scale(1.1); opacity: 1; } 100% { transform: translate(-50%, 0) scale(1); opacity: 1; } }
        @keyframes fadeIn { 0% { opacity: 0; } 100% { opacity: 1; } }
        @keyframes glitch { 0% { transform: translate(-50%,0); } 20% { transform: translate(-52%,2px); } 40% { transform: translate(-48%,-2px); } 60% { transform: translate(-50%,0); } 80% { transform: translate(-51%,-1px); } 100% { transform: translate(-50%,0); } }

        .anim-slide { animation: slideUp 0.3s ease-out forwards; }
        .anim-pop { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .anim-fade { animation: fadeIn 0.4s ease-in forwards; }
        .anim-glitch { animation: glitch 0.3s linear forwards; }
        
        .range-slider { -webkit-appearance: none; width: 100%; height: 4px; background: #333; border-radius: 5px; outline: none; }
        .range-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 12px; height: 12px; border-radius: 50%; background: #3b82f6; cursor: pointer; transition: transform 0.1s; }
        .range-slider::-webkit-slider-thumb:hover { transform: scale(1.2); }
        .font-btn.active, .anim-btn.active { border-color: #3b82f6; background-color: #1e1e2e; color: #3b82f6; }
        .template-card { transition: transform 0.2s, border-color 0.2s; position: relative; overflow: hidden; }
        .template-card:hover { transform: translateY(-2px); border-color: #6366f1; z-index: 10; }

        /* Recording Mode */
        body.recording-mode #sidebar, body.recording-mode #navbar, body.recording-mode #controls { display: none !important; }
        body.recording-mode #main-workspace { background-color: black; height: 100vh; width: 100vw; position: fixed; top: 0; left: 0; z-index: 9999; }
        body.recording-mode #video-wrapper { width: 100%; height: 100%; }
        
        /* Render Overlay Loader */
        #render-loader {
            backdrop-filter: blur(5px);
            transition: opacity 0.3s ease;
        }
        
        /* New Floating Status Bar */
        #system-status {
            position: fixed; top: 24px; left: 50%; transform: translateX(-50%) translateY(-200%); z-index: 10001;
            padding: 10px 24px; border-radius: 99px; background: rgba(20, 20, 20, 0.9); backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
            display: flex; align-items: center; gap: 12px; font-size: 13px; font-weight: 600; color: white;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); pointer-events: none;
        }
        #system-status.active { transform: translateX(-50%) translateY(0); }
        #system-status i { color: #6366f1; }

        @keyframes cyber-stripes { 0% { background-position: 40px 0; } 100% { background-position: 0 0; } }
        .progress-cyber {
            background-image: linear-gradient(45deg, rgba(255, 255, 255, 0.15) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, 0.15) 50%, rgba(255, 255, 255, 0.15) 75%, transparent 75%, transparent);
            background-size: 40px 40px; animation: cyber-stripes 1s linear infinite;
        }
        
        /* Hidden Canvas for Rendering */
        #render-canvas { display: none; }
    </style>
</head>
<body class="h-screen flex flex-col bg-black relative">

    <div id="system-status">
        <div class="relative flex items-center justify-center">
            <span class="absolute inline-flex h-full w-full rounded-full bg-indigo-400 opacity-20 animate-ping"></span>
            <i id="status-icon" class="fa-solid fa-circle-notch fa-spin text-indigo-400 text-sm"></i>
        </div>
        <span id="system-status-text" class="tracking-wide">Menunggu perintah...</span>
    </div>

    <div id="navbar" class="h-14 bg-[#121212] border-b border-[#222] flex items-center justify-between px-6 z-30">
        <div class="flex items-center gap-2">
            <div class="bg-gradient-to-br from-indigo-500 to-purple-600 p-1.5 rounded-lg shadow-lg">
                <i class="fa-solid fa-wand-magic-sparkles text-white text-sm"></i>
            </div>
            <span class="font-bold text-lg tracking-tight text-gray-100">Ailabs <span class="text-indigo-400 font-extrabold">CapCut Lite</span></span>
        </div>
        <div class="flex items-center gap-3">
            <button onclick="document.getElementById('video-upload').click()" class="bg-[#222] hover:bg-[#333] text-gray-200 px-4 py-1.5 rounded-lg text-xs font-semibold transition flex items-center gap-2 border border-[#333]">
                <i class="fa-solid fa-plus"></i> Import Video
            </button>
            <button onclick="renderAndDownload()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-1.5 rounded-lg text-xs font-bold transition flex items-center gap-2 shadow-lg shadow-indigo-900/50">
                <i class="fa-solid fa-video"></i> Export Video (MP4)
            </button>
        </div>
    </div>
    <input type="file" id="video-upload" accept="video/*" class="hidden">

    <div id="main-workspace" class="flex-1 flex overflow-hidden">
        <div id="sidebar" class="w-80 bg-[#121212] border-r border-[#222] flex flex-col z-20 shadow-xl">
            <div class="flex border-b border-[#222]">
                <button onclick="switchTab('style')" id="tab-style" class="flex-1 py-4 text-xs font-bold uppercase tracking-wider bg-[#1a1a1a] text-indigo-400 border-b-2 border-indigo-500 transition-colors">Visual</button>
                <button onclick="switchTab('list')" id="tab-list" class="flex-1 py-4 text-xs font-bold uppercase tracking-wider text-gray-500 hover:bg-[#1a1a1a] hover:text-gray-300 transition-colors">Edit Text</button>
            </div>
            <div id="panel-style" class="p-5 flex-col gap-6 overflow-y-auto h-full scrollbar-hide pb-20">
                <div id="ai-control-panel" class="mb-4 p-4 bg-[#1a1a1a] rounded-xl border border-[#333] relative overflow-hidden group hover:border-indigo-900/50 transition">
                    <div class="flex justify-between items-center mb-2 z-10 relative">
                        <h3 class="text-[10px] font-black text-gray-500 uppercase flex items-center gap-2"><i class="fa-solid fa-microchip"></i> AI ENGINE</h3>
                        <div id="status-badge" class="text-[9px] bg-[#222] text-gray-400 px-2 py-0.5 rounded border border-[#333] transition-colors">Idle</div>
                    </div>
                    <div id="status-area" class="text-[11px] text-gray-300 mb-3 font-medium z-10 relative font-mono">Menunggu Video...</div>
                    <div class="w-full bg-[#000] rounded-full h-1.5 mb-4 overflow-hidden border border-[#333] z-10 relative">
                        <div id="progress-bar" class="bg-gradient-to-r from-indigo-500 to-purple-500 h-full w-0 transition-all duration-300"></div>
                    </div>
                    <button id="btn-process" onclick="startTranscribe()" disabled class="w-full py-2.5 bg-indigo-600 hover:bg-indigo-500 disabled:bg-[#2a2a2a] disabled:text-gray-600 rounded text-[10px] font-bold transition flex items-center justify-center gap-2 z-10 relative shadow-lg shadow-indigo-900/20"><span>GENERATE SUBTITLE</span></button>
                </div>
                <div class="space-y-3">
                    <div class="flex items-center justify-between"><div class="flex items-center gap-2"><i class="fa-solid fa-fire text-orange-500 text-xs"></i><label class="text-[10px] font-bold text-white uppercase tracking-wider">50+ Gaya Populer</label></div></div>
                    <div id="templates-container" class="grid grid-cols-2 gap-2 max-h-[300px] overflow-y-auto pr-1 scrollbar-hide"></div>
                </div>
                <hr class="border-[#222] my-4">
                <div class="space-y-4">
                    <label class="text-[10px] text-gray-500 font-bold mb-2 block uppercase tracking-wider">Pilih Font</label>
                    <div class="grid grid-cols-2 gap-2" id="manual-font-grid">
                        <button onclick="selectFont('Inter', this)" class="font-btn active bg-[#222] border border-[#333] hover:bg-[#2a2a2a] rounded p-2 text-xs text-center transition text-white" style="font-family: 'Inter', sans-serif;">Inter (Biasa)</button>
                        <button onclick="selectFont('Bebas Neue', this)" class="font-btn bg-[#222] border border-[#333] hover:bg-[#2a2a2a] rounded p-2 text-sm text-center transition text-white" style="font-family: 'Bebas Neue', sans-serif;">BEBAS (Tinggi)</button>
                        <button onclick="selectFont('Montserrat', this)" class="font-btn bg-[#222] border border-[#333] hover:bg-[#2a2a2a] rounded p-2 text-xs font-bold text-center transition text-white" style="font-family: 'Montserrat', sans-serif;">Montserrat</button>
                        <button onclick="selectFont('Anton', this)" class="font-btn bg-[#222] border border-[#333] hover:bg-[#2a2a2a] rounded p-2 text-xs text-center transition text-white" style="font-family: 'Anton', sans-serif;">ANTON (Tebal)</button>
                        <button onclick="selectFont('Lobster', this)" class="font-btn bg-[#222] border border-[#333] hover:bg-[#2a2a2a] rounded p-2 text-sm text-center transition text-white" style="font-family: 'Lobster', cursive;">Lobster</button>
                        <button onclick="selectFont('Pacifico', this)" class="font-btn bg-[#222] border border-[#333] hover:bg-[#2a2a2a] rounded p-2 text-sm text-center transition text-white" style="font-family: 'Pacifico', cursive;">Pacifico</button>
                        <button onclick="selectFont('Creepster', this)" class="font-btn bg-[#222] border border-[#333] hover:bg-[#2a2a2a] rounded p-2 text-sm text-center transition text-red-500" style="font-family: 'Creepster', cursive;">HORROR</button>
                        <button onclick="selectFont('Press Start 2P', this)" class="font-btn bg-[#222] border border-[#333] hover:bg-[#2a2a2a] rounded p-2 text-[9px] text-center transition text-green-400" style="font-family: 'Press Start 2P', cursive;">PIXEL</button>
                        <button onclick="selectFont('Comic Neue', this)" class="font-btn bg-[#222] border border-[#333] hover:bg-[#2a2a2a] rounded p-2 text-xs font-bold text-center transition text-white" style="font-family: 'Comic Neue', cursive;">Komik</button>
                        <button onclick="selectFont('Permanent Marker', this)" class="font-btn bg-[#222] border border-[#333] hover:bg-[#2a2a2a] rounded p-2 text-xs text-center transition text-white" style="font-family: 'Permanent Marker', cursive;">Spidol</button>
                    </div>
                    <input type="hidden" id="font-family" value="'Inter', sans-serif">
                    <div class="flex gap-3 pt-2">
                        <div class="flex-1"><label class="text-[9px] text-gray-500 block mb-1">Warna</label><div class="flex items-center gap-2 bg-[#222] p-1.5 rounded-lg border border-[#333]"><input type="color" id="font-color" value="#FFFFFF" class="w-full h-6 bg-transparent border-none cursor-pointer p-0"></div></div>
                        <div class="flex-1"><label class="text-[9px] text-gray-500 block mb-1">Ukuran</label><input type="range" id="font-size" min="8" max="120" value="24" class="range-slider mt-2"></div>
                    </div>
                </div>
                <hr class="border-[#222] my-4">
                <div class="space-y-3">
                    <label class="text-[10px] text-gray-500 font-bold mb-2 block uppercase tracking-wider">Animasi Masuk</label>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="setAnimation('none', this)" class="anim-btn active bg-[#222] border border-[#333] hover:bg-[#2a2a2a] rounded p-2 text-[10px] text-center transition">Mati</button>
                        <button onclick="setAnimation('anim-slide', this)" class="anim-btn bg-[#222] border border-[#333] hover:bg-[#2a2a2a] rounded p-2 text-[10px] text-center transition">Slide Up</button>
                        <button onclick="setAnimation('anim-pop', this)" class="anim-btn bg-[#222] border border-[#333] hover:bg-[#2a2a2a] rounded p-2 text-[10px] text-center transition">Pop In</button>
                        <button onclick="setAnimation('anim-fade', this)" class="anim-btn bg-[#222] border border-[#333] hover:bg-[#2a2a2a] rounded p-2 text-[10px] text-center transition">Fade</button>
                        <button onclick="setAnimation('anim-glitch', this)" class="anim-btn bg-[#222] border border-[#333] hover:bg-[#2a2a2a] rounded p-2 text-[10px] text-center transition text-red-400">Glitch</button>
                    </div>
                </div>
            </div>
            <div id="panel-list" class="hidden flex-1 overflow-y-auto bg-[#121212]">
                <div id="subtitle-list" class="divide-y divide-[#222]">
                    <div class="p-10 text-center flex flex-col items-center justify-center h-64 text-gray-600">
                        <i class="fa-regular fa-closed-captioning text-4xl mb-3 opacity-50"></i>
                        <p class="text-xs">Belum ada subtitle.</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="flex-1 bg-black relative flex items-center justify-center overflow-hidden z-10">
            <div id="video-wrapper" class="relative w-full h-full flex items-center justify-center bg-black">
                <video id="main-video" class="max-w-full max-h-full object-contain" playsinline crossorigin="anonymous"></video>
                <div id="subtitle-overlay">
                    <span id="subtitle-text" class="absolute left-1/2 -translate-x-1/2 px-3 py-1.5 rounded text-center whitespace-pre-wrap leading-snug break-words inline-block transition-all bottom-[10%]"></span>
                </div>
                
                <!-- NEW: Professional Render Loader Overlay -->
                <div id="render-loader" class="absolute inset-0 z-[100] bg-black/90 flex flex-col items-center justify-center hidden">
                    <div class="relative mb-6">
                        <div class="w-20 h-20 border-4 border-zinc-800 border-t-indigo-500 rounded-full animate-spin"></div>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <i class="fa-solid fa-wand-magic-sparkles text-indigo-500 text-2xl animate-pulse"></i>
                        </div>
                    </div>
                    <h3 class="text-white font-bold text-2xl tracking-tight mb-2">Sedang Merender...</h3>
                    <p class="text-indigo-400 text-xs font-mono bg-indigo-900/30 px-3 py-1 rounded-full border border-indigo-500/30">High Performance 60FPS â€¢ <span id="render-format">MP4</span></p>
                    <p class="text-gray-500 text-[10px] mt-8">Mohon jangan tutup tab browser.</p>
                </div>

            </div>
        </div>
    </div>
    <div id="controls" class="h-16 bg-[#121212] border-t border-[#222] flex items-center px-6 gap-5 z-30">
        <button id="btn-play" onclick="togglePlay()" class="w-10 h-10 rounded-full bg-indigo-600 hover:bg-indigo-500 text-white flex items-center justify-center transition shadow-lg"><i class="fa-solid fa-play ml-1"></i></button>
        <div class="flex items-center gap-1 font-mono text-xs text-gray-400 min-w-[100px]"><span id="time-current" class="text-white">00:00</span> / <span id="time-total">00:00</span></div>
        <div class="flex-1 relative group"><input type="range" id="seek-bar" value="0" step="0.1" class="w-full h-1.5 bg-[#333] rounded-lg appearance-none cursor-pointer accent-indigo-500 range-slider"></div>
    </div>

    <!-- Hidden Canvas for Rendering -->
    <canvas id="render-canvas"></canvas>

    <script type="module">
        import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.14.0';
        env.allowLocalModels = false; env.useBrowserCache = true;
        let transcriber = null;
        
        const workerCode = `
            import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.14.0';
            env.allowLocalModels = false; env.useBrowserCache = true;
            let transcriber = null;
            self.addEventListener('message', async (event) => {
                const message = event.data;
                if (message.type === 'load') {
                    try {
                        self.postMessage({ status: 'loading', text: 'Memanaskan Mesin AI...' });
                        transcriber = await pipeline('automatic-speech-recognition', 'Xenova/whisper-small', { progress_callback: (d) => { if (d.status === 'progress') self.postMessage({ status: 'downloading', progress: d.progress }); } });
                        self.postMessage({ status: 'ready' });
                    } catch (e) { self.postMessage({ status: 'error', text: e.message }); }
                }
                if (message.type === 'transcribe') {
                    if (!transcriber) return;
                    try {
                        const output = await transcriber(message.audio, { chunk_length_s: 30, stride_length_s: 5, language: 'indonesian', task: 'transcribe', return_timestamps: true });
                        self.postMessage({ status: 'complete', output: output });
                    } catch (e) { self.postMessage({ status: 'error', text: e.message }); }
                }
            });
        `;
        const blob = new Blob([workerCode], { type: 'application/javascript' });
        const worker = new Worker(URL.createObjectURL(blob), { type: 'module' });

        const templates = [
            { name: "Gold Cinema", font: "'Bebas Neue'", grad: ["#FFD700", "#F9A825"], shadow: {color: "rgba(0,0,0,0.8)", blur: 4, x:2, y:2}, size: 48, stroke: {width: 0, color: 'transparent'}, anim: "anim-fade" },
            { name: "Silver Screen", font: "'Playfair Display'", grad: ["#fff", "#999"], shadow: {color: "#000", blur: 2, x:2, y:2}, size: 32, stroke: {width: 0}, anim: "anim-slide" },
            { name: "Steel Blue", font: "'Bebas Neue'", grad: ["#e0f2fe", "#3b82f6"], shadow: {color: "#000", blur: 4, x:0, y:2}, size: 44, stroke: {width: 0}, anim: "anim-fade" },
            { name: "Bronze", font: "'Oswald'", grad: ["#fdba74", "#9a3412"], shadow: {color: "#000", blur: 0, x:1, y:1}, size: 36, stroke: {width: 0}, anim: "anim-slide" },
            { name: "Noir", font: "'Montserrat'", color: "#fff", bg: "rgba(0,0,0,0.8)", size: 24, stroke: {width: 0}, anim: "anim-fade" },
            { name: "Cyber Pink", font: "'Pacifico'", color: "#fff", shadow: {color: "#d946ef", blur: 15, x:0, y:0}, size: 36, stroke: {width: 0}, anim: "anim-pop" },
            { name: "Tron Blue", font: "'Righteous'", color: "#fff", shadow: {color: "#06b6d4", blur: 15, x:0, y:0}, size: 32, stroke: {width: 0}, anim: "anim-slide" },
            { name: "Toxic Green", font: "'Creepster'", color: "#a3e635", shadow: {color: "#3f6212", blur: 10, x:0, y:0}, size: 42, stroke: {width: 0}, anim: "anim-glitch" },
            { name: "Red District", font: "'Anton'", color: "#fff", stroke: {width: 1, color: "#ef4444"}, shadow: {color: "#b91c1c", blur: 10, x:0, y:0}, size: 38, anim: "anim-pop" },
            { name: "Sunset", font: "'Lobster'", grad: ["#f43f5e", "#fbbf24"], shadow: {color: "#000", blur: 0, x:2, y:2}, size: 34, stroke: {width: 0}, anim: "anim-fade" },
            { name: "Pro Gamer", font: "'Press Start 2P'", color: "#4ade80", shadow: {color: "#000", blur: 0, x:3, y:3}, size: 18, stroke: {width: 0}, anim: "anim-pop" },
            { name: "Firestorm", font: "'Anton'", grad: ["#fbbf24", "#ef4444"], stroke: {width: 1, color: "black"}, size: 40, shadow: {color:"transparent"}, anim: "anim-pop" },
            { name: "Ice Cold", font: "'Righteous'", grad: ["#cffafe", "#06b6d4"], stroke: {width: 1, color: "#155e75"}, size: 34, anim: "anim-slide" },
            { name: "Arcade", font: "'Press Start 2P'", color: "#facc15", shadow: {color: "#ea580c", blur: 0, x:2, y:2}, size: 16, anim: "anim-glitch" },
            { name: "Void", font: "'Oswald'", color: "#fff", bg: "#7c3aed", size: 28, anim: "anim-pop" },
            { name: "Clean Box", font: "'Montserrat'", color: "#000", bg: "#fff", size: 22, anim: "anim-slide" },
            { name: "Dark Mode", font: "'Inter'", color: "#fff", bg: "rgba(0,0,0,0.7)", size: 20, anim: "anim-fade" },
            { name: "Yellow Sub", font: "'Roboto'", color: "#000", bg: "#facc15", size: 24, anim: "anim-pop" },
            { name: "Insta", font: "'Poppins'", grad: ["#f59e0b", "#ec4899", "#8b5cf6"], stroke: {width: 0.5, color: "white"}, size: 28, anim: "anim-fade" },
            { name: "Bold Talk", font: "'Anton'", color: "white", stroke: {width: 1.5, color: "black"}, size: 38, anim: "anim-pop" },
            { name: "Comic Book", font: "'Comic Neue'", color: "#000", bg: "#fff", shadow: {color: "#000", blur: 0, x:4, y:4}, size: 28, anim: "anim-pop" },
            { name: "Bubblegum", font: "'Pacifico'", color: "#f472b6", stroke: {width: 1, color: "#fff"}, size: 36, anim: "anim-pop" },
            { name: "Sky High", font: "'Fredoka One'", color: "#38bdf8", stroke: {width: 1.5, color: "#fff"}, shadow: {color: "#0284c7", blur: 0, x:2, y:2}, size: 32, anim: "anim-slide" },
            { name: "Sunshine", font: "'Chewy'", color: "#facc15", stroke: {width: 1, color: "#ca8a04"}, size: 34, anim: "anim-pop" },
            { name: "Doodle", font: "'Permanent Marker'", color: "#fff", stroke: {width: 1, color: "#000"}, size: 26, anim: "anim-slide" },
            { name: "Impact White", font: "'Anton'", color: "#fff", stroke: {width: 2, color: "#000"}, size: 42, anim: "anim-pop" },
            { name: "Impact Yellow", font: "'Anton'", color: "#facc15", stroke: {width: 2, color: "#000"}, size: 42, anim: "anim-pop" },
            { name: "Impact Red", font: "'Anton'", color: "#ef4444", stroke: {width: 2, color: "#000"}, size: 42, anim: "anim-pop" },
            { name: "Massive", font: "'Bebas Neue'", color: "#fff", bg: "#000", size: 56, anim: "anim-slide" },
            { name: "Headline", font: "'Oswald'", color: "#000", bg: "#e2e8f0", size: 30, anim: "anim-fade" },
            { name: "Royal Gold", font: "'Playfair Display'", grad: ["#bf953f", "#fcf6ba", "#bf953f"], size: 34, anim: "anim-fade" },
            { name: "Rose Gold", font: "'Montserrat'", grad: ["#eecda3", "#ef629f"], size: 28, anim: "anim-slide" },
            { name: "Minimalist", font: "'Inter'", color: "#fff", letterSpacing: 2, size: 20, anim: "anim-fade" },
            { name: "Vogue", font: "'Playfair Display'", color: "#000", bg: "#fff", size: 26, italic: true, anim: "anim-slide" },
            { name: "Rich", font: "'Dancing Script'", color: "#fbbf24", shadow: {color: "#000", blur: 2, x:1, y:1}, size: 38, anim: "anim-fade" },
            { name: "Graffiti", font: "'Permanent Marker'", color: "#a3e635", bg: "#000", size: 30, anim: "anim-pop" },
            { name: "Poster", font: "'Bebas Neue'", color: "#fff", bg: "#dc2626", size: 40, anim: "anim-slide" },
            { name: "Stencil", font: "'Oswald'", color: "#d1d5db", stroke: {width: 1, color: "#000"}, size: 36, anim: "anim-fade" },
            { name: "Underground", font: "'Anton'", color: "#f59e0b", bg: "#1f2937", size: 32, anim: "anim-glitch" },
            { name: "Tag", font: "'Permanent Marker'", color: "#000", bg: "#fca5a5", size: 28, anim: "anim-pop" }
        ];

        let subtitles = [], currentAudioData = null, isVideoLoaded = false;
        let currentStyle = { ...templates[0] };
        let renderCanvas = document.getElementById('render-canvas');
        let renderCtx = renderCanvas.getContext('2d');
        const renderLoader = document.getElementById('render-loader');
        const renderFormatText = document.getElementById('render-format');

        const video = document.getElementById('main-video');
        const overlay = document.getElementById('subtitle-overlay');
        const overlayText = document.getElementById('subtitle-text');
        const videoWrapper = document.getElementById('video-wrapper');
        const statusArea = document.getElementById('status-area');
        const statusBadge = document.getElementById('status-badge');
        const btnProcess = document.getElementById('btn-process');
        const progressBar = document.getElementById('progress-bar');
        const btnPlay = document.getElementById('btn-play');
        const systemStatus = document.getElementById('system-status');
        const systemStatusText = document.getElementById('system-status-text');

        const gridContainer = document.getElementById('templates-container');
        templates.forEach((tmpl, idx) => {
            const div = document.createElement('div');
            div.className = "template-card cursor-pointer bg-[#1a1a1a] border border-[#333] rounded-lg p-2 text-center group h-20 flex flex-col justify-center items-center relative overflow-hidden";
            div.onclick = () => applyTemplate(idx);
            let styleStr = `font-family: ${tmpl.font}; font-size: 14px;`;
            if (tmpl.grad) { styleStr += `background: linear-gradient(to bottom, ${tmpl.grad[0]}, ${tmpl.grad[1]}); -webkit-background-clip: text; -webkit-text-fill-color: transparent;`; }
            else { styleStr += `color: ${tmpl.color || '#fff'};`; if(tmpl.bg) div.style.backgroundColor = tmpl.bg === '#fff' ? '#eee' : tmpl.bg; }
            if (tmpl.shadow) styleStr += `text-shadow: ${tmpl.shadow.x}px ${tmpl.shadow.y}px ${tmpl.shadow.blur}px ${tmpl.shadow.color};`;
            if (tmpl.stroke && tmpl.stroke.width > 0) styleStr += `-webkit-text-stroke: ${tmpl.stroke.width}px ${tmpl.stroke.color || 'black'};`;
            div.innerHTML = `<div class="z-10" style="${styleStr}">${tmpl.name}</div><div class="text-[9px] text-gray-500 mt-1 z-10">${(tmpl.anim || 'none').replace('anim-', '')}</div><div class="absolute inset-0 bg-black/20 group-hover:bg-transparent transition"></div>`;
            gridContainer.appendChild(div);
        });

        window.applyTemplate = (index) => {
            const tmpl = templates[index];
            currentStyle = { ...tmpl };
            const cleanFontName = tmpl.font.replace(/'/g, "");
            let fontVal = cleanFontName;
            if(!fontVal.includes('sans') && !fontVal.includes('serif') && !fontVal.includes('cursive')) {
                 if (['Lobster','Pacifico','Creepster','Press Start 2P','Comic Neue','Permanent Marker','Righteous','Fredoka One','Chewy','Dancing Script'].includes(cleanFontName)) fontVal += ", cursive";
                 else if (['Playfair Display'].includes(cleanFontName)) fontVal += ", serif";
                 else if (['Courier New'].includes(cleanFontName)) fontVal += ", monospace";
                 else fontVal += ", sans-serif";
            }
            document.querySelectorAll('.font-btn').forEach(btn => { btn.classList.remove('active'); if (btn.style.fontFamily.includes(cleanFontName)) btn.classList.add('active'); });
            if(subtitles.length === 0) overlayText.innerText = "Contoh Teks Subtitle";
            renderStyle();
        };

        function renderStyle() {
            overlayText.style.fontFamily = currentStyle.font;
            overlayText.style.fontSize = currentStyle.size + "px";
            overlayText.style.fontStyle = currentStyle.italic ? 'italic' : 'normal';
            overlayText.style.letterSpacing = (currentStyle.letterSpacing || 0) + 'px';
            if (currentStyle.grad) {
                overlayText.style.backgroundImage = `linear-gradient(to bottom, ${currentStyle.grad[0]}, ${currentStyle.grad[1]})`;
                overlayText.style.webkitBackgroundClip = 'text';
                overlayText.style.webkitTextFillColor = 'transparent';
                overlayText.style.color = 'transparent'; 
                overlayText.style.backgroundColor = 'transparent';
            } else {
                overlayText.style.backgroundImage = 'none';
                overlayText.style.webkitBackgroundClip = 'border-box';
                overlayText.style.webkitTextFillColor = 'initial';
                overlayText.style.color = currentStyle.color || '#fff';
                overlayText.style.backgroundColor = currentStyle.bg || 'transparent';
            }
            overlayText.style.textShadow = currentStyle.shadow ? `${currentStyle.shadow.x}px ${currentStyle.shadow.y}px ${currentStyle.shadow.blur}px ${currentStyle.shadow.color}` : 'none';
            if (currentStyle.stroke && currentStyle.stroke.width > 0) {
                overlayText.style.webkitTextStroke = `${currentStyle.stroke.width}px ${currentStyle.stroke.color || 'black'}`;
                overlayText.style.paintOrder = "stroke fill";
            } else { overlayText.style.webkitTextStroke = '0px'; }
            overlayText.classList.remove('anim-slide', 'anim-pop', 'anim-fade', 'anim-glitch');
            if (currentStyle.anim && currentStyle.anim !== 'none') { void overlayText.offsetWidth; overlayText.classList.add(currentStyle.anim); }
            overlayText.style.display = 'inline-block';
            if (!overlayText.style.top) overlayText.classList.add('bottom-[10%]');
        }

        window.selectFont = (fontName, btn) => {
            let family = `'${fontName}', sans-serif`;
            if (['Lobster','Pacifico','Creepster','Press Start 2P','Comic Neue','Permanent Marker','Righteous','Fredoka One','Chewy','Dancing Script'].includes(fontName)) family = `'${fontName}', cursive`;
            else if (['Playfair Display'].includes(fontName)) family = `'${fontName}', serif`;
            else if (['Courier New'].includes(fontName)) family = `'${fontName}', monospace`;
            currentStyle.font = family;
            document.querySelectorAll('.font-btn').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
            if(subtitles.length === 0) overlayText.innerText = "Contoh Teks Subtitle";
            renderStyle();
        };
        document.getElementById('font-color').addEventListener('input', (e) => { currentStyle.color = e.target.value; currentStyle.grad = null; currentStyle.bg = null; renderStyle(); });
        document.getElementById('font-size').addEventListener('input', (e) => { currentStyle.size = e.target.value; renderStyle(); });
        window.setAnimation = (anim, btn) => { currentStyle.anim = anim; document.querySelectorAll('.anim-btn').forEach(b => b.classList.remove('active')); if(btn) btn.classList.add('active'); renderStyle(); };

        function resizeOverlay() {
            if (!video || !video.videoWidth) return;
            const vR = video.videoWidth/video.videoHeight, wR = videoWrapper.clientWidth/videoWrapper.clientHeight;
            let w, h;
            if (wR > vR) { h = videoWrapper.clientHeight; w = h * vR; } else { w = videoWrapper.clientWidth; h = w / vR; }
            overlay.style.width = w + 'px'; overlay.style.height = h + 'px';
        }
        window.addEventListener('resize', resizeOverlay);
        video.addEventListener('loadedmetadata', () => { resizeOverlay(); document.getElementById('seek-bar').max = video.duration; document.getElementById('time-total').innerText = formatTime(video.duration); });

        worker.postMessage({ type: 'load' });
        worker.onmessage = (e) => {
            const { status, progress, output, text } = e.data;
            if (status==='downloading') { 
                statusArea.innerText = `Mengambil Data: ${Math.round(progress)}%`; 
                statusBadge.innerText = "Downloading...";
                statusBadge.className = "text-[9px] bg-blue-900/50 text-blue-400 px-2 py-0.5 rounded border border-blue-700 animate-pulse";
                progressBar.style.width = `${progress}%`; 
                // Add striped animation class
                progressBar.className = "bg-indigo-500 h-full w-0 transition-all duration-300 progress-cyber";
            }
            else if (status==='ready') { 
                statusArea.innerText = "Mesin AI Siap Digunakan."; 
                statusBadge.innerText = "Ready";
                statusBadge.className = "text-[9px] bg-green-900/50 text-green-400 px-2 py-0.5 rounded border border-green-700";
                progressBar.style.width = '100%';
                progressBar.className = "bg-green-500 h-full w-0 transition-all duration-300"; // Remove stripes 
                if(isVideoLoaded) btnProcess.disabled=false; 
            }
            else if (status==='complete') { 
                statusArea.innerText = "Selesai!"; btnProcess.disabled=false; btnProcess.innerText="GENERATE ULANG"; parseSubtitles(output); window.switchTab('style'); 
                showSystemStatus("Transkripsi Selesai!", "text-green-400", 2000);
            }
            else if (status==='loading') { statusArea.innerText = text; }
        };

        document.getElementById('video-upload').addEventListener('change', async (e) => {
            const file = e.target.files[0]; if(!file) return;
            video.src = URL.createObjectURL(file); isVideoLoaded = true;
            statusArea.innerText = "Siap Import Video (AI Standby)"; 
            if(progressBar.style.width === '100%') btnProcess.disabled=false;
            subtitles=[];
            try {
                const ab = await file.arrayBuffer();
                const ac = new (window.AudioContext||window.webkitAudioContext)({sampleRate:16000});
                const aud = await ac.decodeAudioData(ab);
                currentAudioData = aud.getChannelData(0);
                if(progressBar.style.width === '100%') statusArea.innerText = "Video & Audio Siap. Klik Generate.";
            } catch(e){ statusArea.innerText = "Gagal memproses audio."; }
        });

        window.startTranscribe = () => {
            if(!currentAudioData) return;
            btnProcess.disabled=true; btnProcess.innerHTML='<i class="fa-solid fa-circle-notch fa-spin"></i> MEMPROSES...'; 
            statusArea.innerText="Sedang Menganalisa Suara...";
            showSystemStatus("Sedang Mentranskripsi Audio...", "text-yellow-400");
            worker.postMessage({ type: 'transcribe', audio: currentAudioData });
        };

        function parseSubtitles(output) {
            subtitles = (output.chunks||[]).map((c,i)=>({id:i, start:c.timestamp[0], end:c.timestamp[1]||c.timestamp[0]+3, text:c.text.trim()}));
            if(subtitles.length===0 && output.text) subtitles=[{id:0,start:0,end:5,text:output.text}];
            renderSubtitleList();
        }

        video.ontimeupdate = () => {
            const t = video.currentTime;
            document.getElementById('seek-bar').value = t;
            document.getElementById('time-current').innerText = formatTime(t);
            const active = subtitles.find(s => t >= s.start && t <= s.end);
            if (active) {
                if(overlayText.innerText !== active.text) {
                    overlayText.innerText = active.text;
                    const anim = currentStyle.anim;
                    if(anim && anim !== 'none') { overlayText.classList.remove(anim); void overlayText.offsetWidth; overlayText.classList.add(anim); }
                    highlightList(active.id);
                }
                overlayText.style.display = 'inline-block';
            } else { if(subtitles.length > 0) overlayText.style.display = 'none'; }
        };

        let isDragging=false, startY, startTop;
        overlayText.addEventListener('mousedown', (e) => {
            isDragging=true; e.preventDefault(); startY=e.clientY;
            const pRect=overlay.getBoundingClientRect(), tRect=overlayText.getBoundingClientRect();
            if(!overlayText.style.top || overlayText.style.top==='auto') { overlayText.style.bottom='auto'; overlayText.style.top=(tRect.top-pRect.top)+'px'; }
            startTop=parseInt(overlayText.style.top); overlayText.style.cursor='grabbing';
            document.addEventListener('mousemove', onDrag); document.addEventListener('mouseup', endDrag);
        });
        function onDrag(e) { if(!isDragging) return; overlayText.style.top = (startTop + e.clientY - startY) + 'px'; }
        function endDrag() { isDragging=false; overlayText.style.cursor='move'; document.removeEventListener('mousemove', onDrag); document.removeEventListener('mouseup', endDrag); }

        window.togglePlay = () => { if(video.paused) video.play().catch(()=>{}); else video.pause(); };
        document.getElementById('seek-bar').addEventListener('input', (e) => video.currentTime = e.target.value);
        function formatTime(s) { if(!s || isNaN(s)) return "00:00"; return `${Math.floor(s/60).toString().padStart(2,'0')}:${Math.floor(s%60).toString().padStart(2,'0')}`; }
        window.switchTab = (t) => {
            document.getElementById('panel-style').classList.toggle('hidden', t!=='style');
            document.getElementById('panel-list').classList.toggle('hidden', t!=='list');
            document.getElementById('tab-style').className = t==='style' ? "flex-1 py-4 text-xs font-bold uppercase tracking-wider bg-[#1a1a1a] text-indigo-400 border-b-2 border-indigo-500 transition" : "flex-1 py-4 text-xs font-bold uppercase tracking-wider text-gray-500 hover:bg-[#1a1a1a] transition";
            document.getElementById('tab-list').className = t==='list' ? "flex-1 py-4 text-xs font-bold uppercase tracking-wider bg-[#1a1a1a] text-indigo-400 border-b-2 border-indigo-500 transition" : "flex-1 py-4 text-xs font-bold uppercase tracking-wider text-gray-500 hover:bg-[#1a1a1a] transition";
        };
        function renderSubtitleList() {
            const list = document.getElementById('subtitle-list'); list.innerHTML = "";
            subtitles.forEach(s => {
                const d = document.createElement('div'); d.id=`sub-${s.id}`; d.className="p-4 border-l-2 border-transparent hover:bg-[#1a1a1a] cursor-pointer group";
                d.onclick=()=>{ video.currentTime=s.start; video.play().catch(()=>{}); };
                d.innerHTML=`<div class="flex justify-between text-[10px] text-gray-500 mb-1"><span>${formatTime(s.start)}</span><span>#${s.id+1}</span></div><textarea class="w-full bg-[#1a1a1a] border border-[#333] rounded p-2 text-xs text-gray-300 h-auto" onchange="updateSub(${s.id},this.value)" onclick="event.stopPropagation()">${s.text}</textarea>`;
                list.appendChild(d);
            });
        }
        window.updateSub = (id,txt) => { const s=subtitles.find(x=>x.id===id); if(s) s.text=txt; };
        function highlightList(id) { document.querySelectorAll('[id^="sub-"]').forEach(e=>{e.classList.remove('border-indigo-500','bg-[#1a1a1a]');}); const el=document.getElementById(`sub-${id}`); if(el){el.classList.add('border-indigo-500','bg-[#1a1a1a]'); el.scrollIntoView({behavior:"smooth",block:"center"});} }
        
        function showSystemStatus(msg, colorClass="text-indigo-400", duration=0) {
            const el = document.getElementById('system-status');
            const icon = document.getElementById('status-icon');
            const text = document.getElementById('system-status-text');
            el.classList.add('active');
            text.innerText = msg;
            icon.className = `fa-solid fa-circle-notch fa-spin text-sm ${colorClass}`;
            if(duration > 0) setTimeout(() => el.classList.remove('active'), duration);
        }

        // --- NEW AUTO RENDER ENGINE (60 FPS + HIGH BITRATE) ---
        window.renderAndDownload = async () => {
            if(!isVideoLoaded) return alert("Video belum ada!");
            
            // Show CENTER Overlay Loader
            renderLoader.classList.remove('hidden');
            
            // Setup Canvas size to match video
            renderCanvas.width = video.videoWidth;
            renderCanvas.height = video.videoHeight;
            
            const canvasStream = renderCanvas.captureStream(60); // Request 60 FPS
            let audioStream;
            try {
                const vidStream = video.captureStream();
                if(vidStream.getAudioTracks().length > 0) {
                    audioStream = vidStream.getAudioTracks()[0];
                }
            } catch(e) { console.log("Audio capture fallback"); }

            const tracks = [...canvasStream.getVideoTracks()];
            if(audioStream) tracks.push(audioStream);
            const combinedStream = new MediaStream(tracks);

            // Select Mime Type (Prefer MP4, Fallback WebM)
            const types = [
                "video/mp4;codecs=avc1.42E01E,mp4a.40.2", 
                "video/mp4",
                "video/webm;codecs=vp9", 
                "video/webm"
            ];
            let mimeType = "video/webm";
            let ext = "webm";

            for (const t of types) {
                if (MediaRecorder.isTypeSupported(t)) {
                    mimeType = t;
                    if (t.includes("mp4")) ext = "mp4";
                    break;
                }
            }
            
            renderFormatText.innerText = ext.toUpperCase();

            // Set High Bitrate (25 Mbps for 1080p/4K crispness)
            const recorder = new MediaRecorder(combinedStream, { mimeType: mimeType, videoBitsPerSecond: 25000000 });
            const chunks = [];
            recorder.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data); };
            
            recorder.onstop = () => {
                // Hide Loader
                renderLoader.classList.add('hidden');
                
                const blob = new Blob(chunks, { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); 
                a.href = url; 
                a.download = `Ailabs_Export_Auto.${ext}`; 
                a.click();
                
                // Cleanup
                cancelAnimationFrame(renderLoopId); // Stop render loop
                video.onended = null;
                // Restore UI
                video.ontimeupdate = () => {
                    const t = video.currentTime;
                    document.getElementById('seek-bar').value = t;
                    document.getElementById('time-current').innerText = formatTime(t);
                    const active = subtitles.find(s => t >= s.start && t <= s.end);
                    if (active) {
                        if(overlayText.innerText !== active.text) overlayText.innerText = active.text;
                        overlayText.style.display = 'inline-block';
                    } else if(subtitles.length > 0) overlayText.style.display = 'none';
                };
                showSystemStatus("Download Selesai!", "text-green-400", 3000);
            };

            recorder.start();
            video.currentTime = 0;
            video.play().catch(()=>{});

            // 60FPS RENDER LOOP (RAF)
            let renderLoopId;
            const drawFrame = () => {
                // Draw Video
                renderCtx.drawImage(video, 0, 0, renderCanvas.width, renderCanvas.height);
                
                // Draw Text
                const active = subtitles.find(s => video.currentTime >= s.start && video.currentTime <= s.end);
                if (active) {
                    renderCtx.save();
                    const scale = renderCanvas.width / videoWrapper.clientWidth; 
                    
                    let fontSize = parseInt(currentStyle.size) * scale * 1.5; 
                    renderCtx.font = `${currentStyle.italic?'italic ':''}${fontSize}px ${currentStyle.font.replace(/'/g, "")}`;
                    renderCtx.textAlign = "center";
                    renderCtx.textBaseline = "bottom";
                    
                    let yPos = renderCanvas.height * 0.9;
                    if(overlayText.style.top && overlayText.style.top !== 'auto') {
                        yPos = renderCanvas.height * 0.9; 
                    }
                    const xPos = renderCanvas.width / 2;

                    if (currentStyle.bg) {
                        renderCtx.fillStyle = currentStyle.bg;
                        const metrics = renderCtx.measureText(active.text);
                        const bgH = fontSize * 1.2;
                        const bgW = metrics.width + (fontSize);
                        renderCtx.fillRect(xPos - bgW/2, yPos - bgH + (fontSize*0.2), bgW, bgH);
                    }
                    if (currentStyle.shadow) {
                        renderCtx.shadowColor = currentStyle.shadow.color;
                        renderCtx.shadowBlur = currentStyle.shadow.blur * scale;
                        renderCtx.shadowOffsetX = currentStyle.shadow.x * scale;
                        renderCtx.shadowOffsetY = currentStyle.shadow.y * scale;
                    }
                    if (currentStyle.stroke && currentStyle.stroke.width > 0) {
                        renderCtx.lineWidth = currentStyle.stroke.width * scale;
                        renderCtx.strokeStyle = currentStyle.stroke.color || 'black';
                        renderCtx.strokeText(active.text, xPos, yPos);
                    }
                    if (currentStyle.grad) {
                        const gradient = renderCtx.createLinearGradient(xPos, yPos - fontSize, xPos, yPos);
                        gradient.addColorStop(0, currentStyle.grad[0]);
                        gradient.addColorStop(1, currentStyle.grad[1]);
                        renderCtx.fillStyle = gradient;
                    } else {
                        renderCtx.fillStyle = currentStyle.color || 'white';
                    }
                    renderCtx.fillText(active.text, xPos, yPos);
                    renderCtx.restore();
                }
                
                renderLoopId = requestAnimationFrame(drawFrame);
            };
            
            // Start the High Speed Loop
            drawFrame();

            video.onended = () => {
                recorder.stop();
            };
        };

        applyTemplate(0);
    </script>
</body>
</html>